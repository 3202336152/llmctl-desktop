name: Build Electron App

on:
  push:
    branches: [ main, master ]
    paths:
      - 'electron-app/**'
      - '.github/workflows/build-electron.yml'
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v2.1.3ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: pip install setuptools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm install

      - name: Configure API URL
        working-directory: electron-app
        run: |
          echo "REACT_APP_API_BASE_URL=http://117.72.200.2:8080/llmctl" > .env
          echo "LLMCTL_API_BASE_URL=http://117.72.200.2:8080/llmctl" >> .env

      - name: Build and package Windows
        working-directory: electron-app
        run: |
          npm run build
          npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-Windows-Installer
          path: electron-app/release/LLMctl Setup *.exe
          retention-days: 30
          if-no-files-found: error

      - name: Upload Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-Windows-Portable
          path: electron-app/release/win-unpacked/
          retention-days: 30
          if-no-files-found: warn

  build-macos:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: pip install setuptools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm install

      - name: Configure API URL
        working-directory: electron-app
        run: |
          echo "REACT_APP_API_BASE_URL=http://117.72.200.2:8080/llmctl" > .env
          echo "LLMCTL_API_BASE_URL=http://117.72.200.2:8080/llmctl" >> .env

      - name: Build and package macOS
        working-directory: electron-app
        run: |
          npm run build
          npm run dist:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-macOS-Installer
          path: electron-app/release/LLMctl-*.dmg
          retention-days: 30
          if-no-files-found: error

  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: pip install setuptools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm install

      - name: Configure API URL
        working-directory: electron-app
        run: |
          echo "REACT_APP_API_BASE_URL=http://117.72.200.2:8080/llmctl" > .env
          echo "LLMCTL_API_BASE_URL=http://117.72.200.2:8080/llmctl" >> .env

      - name: Build and package Linux
        working-directory: electron-app
        run: |
          npm run build
          npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux Installer
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-Linux-Installer
          path: electron-app/release/LLMctl-*.AppImage
          retention-days: 30
          if-no-files-found: error

  # Release Job - ä»…åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è¿è¡Œ
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    if: startsWith(github.ref, 'refs/tags/v')  # ä»…åœ¨ v* æ ‡ç­¾æ—¶è¿è¡Œ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-Windows-Installer
          path: ./artifacts/windows/

      - name: Download macOS Installer
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-macOS-Installer
          path: ./artifacts/macos/

      - name: Download Linux Installer
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-Linux-Installer
          path: ./artifacts/linux/

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          name: LLMctl ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## ğŸ‰ LLMctl ${{ github.ref_name }} å‘å¸ƒ

            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            - **Windows**: LLMctl-Setup.exe
            - **macOS**: LLMctl.dmg
            - **Linux**: LLMctl.AppImage

            ### ğŸ”§ æ„å»ºä¿¡æ¯
            - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}

            ### ğŸ”§ æ›´æ–°å†…å®¹
            ${{ github.event.head_commit.message }}

            ### ğŸ“‹ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. Windows: åŒå‡» .exe æ–‡ä»¶å®‰è£…
            3. macOS: æ‰“å¼€ .dmg æ–‡ä»¶æ‹–æ‹½åˆ° Applications
            4. Linux: ç»™ AppImage æ·»åŠ æ‰§è¡Œæƒé™åè¿è¡Œ

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦å…è®¸åº”ç”¨è¿è¡Œ
            - Windows å¯èƒ½éœ€è¦å…³é—­å®‰å…¨è½¯ä»¶è­¦å‘Š

            ---

            ğŸ”— [é¡¹ç›®ä¸»é¡µ](https://github.com/3202336152/llmctl-desktop)
            ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/3202336152/llmctl-desktop/wiki)
          files: |
            ./artifacts/windows/LLMctl Setup *.exe
            ./artifacts/macos/LLMctl-*.dmg
            ./artifacts/linux/LLMctl-*.AppImage
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
