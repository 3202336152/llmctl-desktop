name: Build Electron App

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v2.1.3ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# å£°æ˜ Workflow æ‰€éœ€æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„æº

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: pip install setuptools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm install

      - name: Configure API URL
        working-directory: electron-app
        run: |
          echo "REACT_APP_API_BASE_URL=http://117.72.200.2:8080/llmctl" > .env
          echo "LLMCTL_API_BASE_URL=http://117.72.200.2:8080/llmctl" >> .env

      - name: Build and package Windows
        working-directory: electron-app
        run: |
          npm run build
          npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ä»…åœ¨ tag æ¨é€æ—¶å‘å¸ƒï¼Œç”Ÿæˆ latest.yml
          PUBLISH: ${{ startsWith(github.ref, 'refs/tags/v') && 'always' || 'never' }}

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-Windows-Installer
          path: electron-app/release/LLMctl.Setup.*.exe
          retention-days: 30
          if-no-files-found: error

      - name: Upload Windows Portable (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-Windows-Portable
          path: electron-app/release/LLMctl-*.zip
          retention-days: 30
          if-no-files-found: error

      - name: Upload latest.yml for Auto-Update
        uses: actions/upload-artifact@v4
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: LLMctl-Windows-Update-Info
          path: electron-app/release/latest.yml
          retention-days: 30
          if-no-files-found: warn

  build-macos:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: pip install setuptools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm install

      - name: Configure API URL
        working-directory: electron-app
        run: |
          echo "REACT_APP_API_BASE_URL=http://117.72.200.2:8080/llmctl" > .env
          echo "LLMCTL_API_BASE_URL=http://117.72.200.2:8080/llmctl" >> .env

      - name: Build and package macOS
        working-directory: electron-app
        run: |
          npm run build
          npm run dist:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-macOS-Installer
          path: electron-app/release/LLMctl-*.dmg
          retention-days: 30
          if-no-files-found: error

  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build tools
        run: pip install setuptools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm install

      - name: Configure API URL
        working-directory: electron-app
        run: |
          echo "REACT_APP_API_BASE_URL=http://117.72.200.2:8080/llmctl" > .env
          echo "LLMCTL_API_BASE_URL=http://117.72.200.2:8080/llmctl" >> .env

      - name: Build and package Linux
        working-directory: electron-app
        run: |
          npm run build
          npm run dist:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux Installer
        uses: actions/upload-artifact@v4
        with:
          name: LLMctl-Linux-Installer
          path: electron-app/release/LLMctl-*.AppImage
          retention-days: 30
          if-no-files-found: error

  # Release Job - ä»…åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è¿è¡Œ
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    if: startsWith(github.ref, 'refs/tags/v')  # ä»…åœ¨ v* æ ‡ç­¾æ—¶è¿è¡Œ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-Windows-Installer
          path: ./artifacts/windows/

      - name: Download Windows Portable
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-Windows-Portable
          path: ./artifacts/windows/

      - name: Download Windows Update Info
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-Windows-Update-Info
          path: ./artifacts/windows/
        continue-on-error: true

      - name: Download macOS Installer
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-macOS-Installer
          path: ./artifacts/macos/

      - name: Download Linux Installer
        uses: actions/download-artifact@v4
        with:
          name: LLMctl-Linux-Installer
          path: ./artifacts/linux/

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          name: LLMctl ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## ğŸ‰ LLMctl ${{ github.ref_name }} å‘å¸ƒ

            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            - **Windows å®‰è£…ç‰ˆ**: `LLMctl Setup.exe` - éœ€è¦å®‰è£…åˆ°ç³»ç»Ÿ
            - **Windows ä¾¿æºç‰ˆ**: `LLMctl-xxx-win.zip` - è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
            - **macOS**: `LLMctl.dmg` - DMG é•œåƒæ–‡ä»¶
            - **Linux**: `LLMctl.AppImage` - AppImage å¯æ‰§è¡Œæ–‡ä»¶
            - **è‡ªåŠ¨æ›´æ–°é…ç½®**: `latest.yml` - ç”¨äºåº”ç”¨å†…è‡ªåŠ¨æ›´æ–°æ£€æµ‹

            ### ğŸš€ Windows ä¾¿æºç‰ˆä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½ `LLMctl-xxx-win.zip` æ–‡ä»¶
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. åŒå‡» `LLMctl.exe` å³å¯è¿è¡Œ
            4. æ— éœ€å®‰è£…ï¼Œå¯ç›´æ¥å¤åˆ¶åˆ°Uç›˜ä½¿ç”¨

            ### ğŸ”§ æ„å»ºä¿¡æ¯
            - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}

            ### ğŸ”§ æ›´æ–°å†…å®¹
            ${{ github.event.head_commit.message }}

            ### ğŸ“‹ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. **Windows å®‰è£…ç‰ˆ**: åŒå‡» .exe æ–‡ä»¶å®‰è£…
            3. **Windows ä¾¿æºç‰ˆ**: è§£å‹ .zip æ–‡ä»¶åè¿è¡Œ LLMctl.exe
            4. **macOS**: æ‰“å¼€ .dmg æ–‡ä»¶æ‹–æ‹½åˆ° Applications
            5. **Linux**: ç»™ AppImage æ·»åŠ æ‰§è¡Œæƒé™åè¿è¡Œ

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦å…è®¸åº”ç”¨è¿è¡Œ
            - Windows å¯èƒ½éœ€è¦å…³é—­å®‰å…¨è½¯ä»¶è­¦å‘Š
            - ä¾¿æºç‰ˆæ•°æ®å­˜å‚¨åœ¨ç”¨æˆ·ç›®å½•ï¼Œå¸è½½æ—¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤

            ---

            ğŸ”— [é¡¹ç›®ä¸»é¡µ](https://github.com/3202336152/llmctl-desktop)
            ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/3202336152/llmctl-desktop/wiki)
          files: |
            ./artifacts/windows/LLMctl.Setup.*.exe
            ./artifacts/windows/LLMctl-*.zip
            ./artifacts/windows/latest.yml
            ./artifacts/macos/LLMctl-*.dmg
            ./artifacts/linux/LLMctl-*.AppImage
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
