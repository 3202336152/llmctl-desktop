<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.llmctl.mapper.UsageStatisticsMapper">

    <!-- UsageStatistics结果映射 -->
    <resultMap id="UsageStatisticsResultMap" type="com.llmctl.entity.UsageStatistics">
        <id column="id" property="id"/>
        <result column="provider_id" property="providerId"/>
        <result column="token_id" property="tokenId"/>
        <result column="request_count" property="requestCount"/>
        <result column="success_count" property="successCount"/>
        <result column="error_count" property="errorCount"/>
        <result column="total_tokens" property="totalTokens"/>
        <result column="date" property="date"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 根据ID查询使用统计 -->
    <select id="findById" parameterType="long" resultMap="UsageStatisticsResultMap">
        SELECT * FROM usage_statistics WHERE id = #{id}
    </select>

    <!-- 根据Provider ID和日期查询统计 -->
    <select id="findByProviderIdAndDate" resultMap="UsageStatisticsResultMap">
        SELECT * FROM usage_statistics WHERE provider_id = #{providerId} AND date = #{date}
    </select>

    <!-- 根据日期范围查询统计 -->
    <select id="findByDateRange" resultMap="UsageStatisticsResultMap">
        SELECT * FROM usage_statistics WHERE date BETWEEN #{startDate} AND #{endDate} ORDER BY date DESC
    </select>

    <!-- 获取每日统计汇总 -->
    <select id="getDailySummary" resultMap="UsageStatisticsResultMap">
        SELECT date,
               SUM(request_count) as request_count,
               SUM(success_count) as success_count,
               SUM(error_count) as error_count,
               SUM(total_tokens) as total_tokens
        FROM usage_statistics
        WHERE date BETWEEN #{startDate} AND #{endDate}
        GROUP BY date ORDER BY date DESC
    </select>

    <!-- 获取Provider统计汇总 -->
    <select id="getProviderSummary" resultMap="UsageStatisticsResultMap">
        SELECT provider_id,
               SUM(request_count) as request_count,
               SUM(success_count) as success_count,
               SUM(error_count) as error_count,
               SUM(total_tokens) as total_tokens
        FROM usage_statistics
        WHERE date BETWEEN #{startDate} AND #{endDate}
        GROUP BY provider_id ORDER BY request_count DESC
    </select>

    <!-- 插入或更新统计记录 -->
    <insert id="insertOrUpdate" parameterType="com.llmctl.entity.UsageStatistics">
        INSERT INTO usage_statistics (provider_id, token_id, request_count, success_count, error_count, total_tokens, date, created_at, updated_at)
        VALUES (#{providerId}, #{tokenId}, #{requestCount}, #{successCount}, #{errorCount}, #{totalTokens}, #{date}, #{createdAt}, #{updatedAt})
        ON DUPLICATE KEY UPDATE
            request_count = request_count + VALUES(request_count),
            success_count = success_count + VALUES(success_count),
            error_count = error_count + VALUES(error_count),
            total_tokens = total_tokens + VALUES(total_tokens),
            updated_at = VALUES(updated_at)
    </insert>

    <!-- 插入统计记录 -->
    <insert id="insert" parameterType="com.llmctl.entity.UsageStatistics" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO usage_statistics (provider_id, token_id, request_count, success_count, error_count, total_tokens, date, created_at, updated_at)
        VALUES (#{providerId}, #{tokenId}, #{requestCount}, #{successCount}, #{errorCount}, #{totalTokens}, #{date}, #{createdAt}, #{updatedAt})
    </insert>

    <!-- 更新统计记录 -->
    <update id="update" parameterType="com.llmctl.entity.UsageStatistics">
        UPDATE usage_statistics SET
            request_count = #{requestCount},
            success_count = #{successCount},
            error_count = #{errorCount},
            total_tokens = #{totalTokens},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <!-- 删除指定日期之前的统计记录 -->
    <delete id="deleteBefore" parameterType="java.time.LocalDate">
        DELETE FROM usage_statistics WHERE date &lt; #{beforeDate}
    </delete>

    <!-- 根据Provider ID删除统计记录 -->
    <delete id="deleteByProviderId" parameterType="string">
        DELETE FROM usage_statistics WHERE provider_id = #{providerId}
    </delete>

    <!-- 根据Token ID删除统计记录 -->
    <delete id="deleteByTokenId" parameterType="string">
        DELETE FROM usage_statistics WHERE token_id = #{tokenId}
    </delete>

    <!-- 统计总请求数 -->
    <select id="getTotalRequests" resultType="long">
        SELECT COALESCE(SUM(request_count), 0) FROM usage_statistics
        WHERE date BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 统计总成功数 -->
    <select id="getTotalSuccesses" resultType="long">
        SELECT COALESCE(SUM(success_count), 0) FROM usage_statistics
        WHERE date BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 统计总Token消耗 -->
    <select id="getTotalTokensUsed" resultType="long">
        SELECT COALESCE(SUM(total_tokens), 0) FROM usage_statistics
        WHERE date BETWEEN #{startDate} AND #{endDate}
    </select>

</mapper>